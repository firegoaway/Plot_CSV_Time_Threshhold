# PCTT - Plot CSV Time Threshold

> Язык: **Python**

> Интерфейс: **Tkinter**

## Особенности и описание работы утилиты
Утилита расчитывает **честное** значение **tпор** тремя разными способами, отображает на графике значения параметра, воздействующего на пожарный извещатель во всех точках области **F** и определяет **dэфф**.

> Начиная с версии ***0.3.1*** работает только в связке с утилитой [**Zmejka**](https://github.com/firegoaway/Zmejka). При этом утилиту **PCTT** можно легко адаптировать под телеграм-бота.

### Метод
1. Пользователь указывает путь к файлу сценария FDS (.fds), вводит запрашиваемые данные, выбирает параметр, воздействующий на пожарный извещатель;
2. В каждой точке расчётной области, на высоте размещения пожарных извещателей, добавляется регистратор (измеритель) этого параметра с определённым паттерном в названии *(DEVC_XnYm_MESH_N)*, указывается пороговое значение, присваиваемое каждому регистратору (измерителю). Пороговое значение определяется строго по [Методике](https://ivo.garant.ru/#/document/406577165/paragraph/1532/doclist/6480/1/0/0/методика%201140:0);
3. Далее пользователь нажимает **"Старт"** и ожидает окончания моделирования пожара;
4. FDS расчитывает значение параметра в каждой точке расчётной области **F**. Количество точек в области **F** зависит от размера ячейки;
5. После этого пользователь запускает утилиту **PCTT**, вновь указывает **Hпом** (высоту помещения с очагом пожара), **Cs** (размер ячейки) и путь к результатам расчёта **"_devc.csv"**;
6. Утилита очищает таблицу от лишних *&DEVC*, преобразует научную нотацию записей в обыкновенный математический вид, далее ищет строку, в которой количество ячеек, значение в каждой из которых превышает (в случае с параметром *VISIBILITY* не превышает) пороговое, превышает количество точек **Cc**, в области **F**, необходимое для получения такой площади области **F**, при которой значение эффективного диаметра **dэфф** будет больше или равно нормативному расстоянию между пожарными извещателями. При этом нормативное расстояние между извещателями определяется по формуле ![L_latex](https://raw.githubusercontent.com/firegoaway/Plot_CSV_Time_Threshhold/main/.gitpics/L_latex.jpg)
7. Таким образом, программа расчитывает **tпор** строго по [пунктам 1 и 2 приложения 11 Методики 1140](https://ivo.garant.ru/#/document/406577165/paragraph/1532/doclist/6480/1/0/0/методика%201140:0).

### Методология
Поскольку пользовательскому сообществу Fenix+ 3 доподлинно неизвестна природа происхождения значения ***tпор*** в отчёте, как и неизвестна методология его вычисления, [**Ниса**](https://t.me/nisadypova) добавила в программу функцию вычисления не только ***tпор***, но и ***F (dэфф)*** так, чтобы строго соблюдались [**пункты 1 и 2 приложения 11 Методики 1140**](https://ivo.garant.ru/#/document/406577165/paragraph/1532/doclist/6480/1/0/0/%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D0%B8%D0%BA%D0%B0%201140:0).

В каждую точку (ячейку) расчётной области, на высоте расположения пожарных извещателей, добавляется измеритель (регистратор) параметра, воздействующего на пожарный извещатель.

Пользователь может выбрать, какой параметр будет воздействовать на извещатель в процессе моделирования. На выбор доступны 3 параметра:
- Видимость (**VISIBILITY**)
- Коэффициент пропускания света (**EXTINCTION COEFFICIENT**)
- Оптическая плотность (**OPTICAL DENSITY**)

В FDS ***EXTINCTION COEFFICIENT*** и ***OPTICAL DENSITY*** не учитывают водяной пар, который часто, хоть и в малых количествах, но всё же присутствует в составе дыма.

Параметр ***VISIBILITY*** - весьма перспективный параметр, воздействующий на дымовой пожарный извещатель, и выбран не случайно. Он является частью спектрально-массовой характеристики веществ (SPEC) в FDS и учитывает не только водяной пар, но и прочие химические составы (SPEC), которые пользователь добавляет в реакцию.

Его пороговое значение опредяется так:

`SETPOINT` (м) = MAXIMUM_VISIBILITY - 2.38 \* ln(MAXIMUM_VISIBILITY) ≈ **21.9052 м**

Тесты показали, что *VISIBILITY* приближается к значению 21.9052 м тогда, когда значение *EXTINCTION_COEFFICIENT* приближается к пороговому 0.04605 1/м.

Расчёт критического значения по видимости для пожарного извещателя представлен в файле **Расчёт_VisL.sm**. 

Расчёт критических значений ***F*** и ***dэфф***, а также значение расстояния между извещателями ***L*** в табличном виде, представлены в файле **Расчёт_Fmax.sm**.

Файлы с расширением **.sm** можно открыть с помощью [**SMath**](https://www.smath.com/ru-RU/).

Интерпретация этих величин и их согласованность - важный вопрос, который лежит на стыке физики, метрологии и практики моделирования. Разберем его строго.

**Переводить необходимо.** Если в Методике указано предельное значение **0.2 дБ/м**, то в `SETPOINT` в FDS мы должны указать значение в **1/м**, рассчитанное путем преобразования единиц.

Преобразование выглядит так:
`SETPOINT` (1/м) = (0.2 дБ/м) / (10 \* log10(e)) ≈ **0.04605 1/м**

Чтобы доказать это, нужно понять физическую природу величин и математическую связь между ними.

\*   **Extinction Coefficient (βₑ или σ) в FDS:** Это **линейный показатель ослабления** (attenuation coefficient) в системе СИ. Он определяется через **Закон Бугера — Ламберта — Бера** в его основной форме:
    `I / I₀ = exp(-σ * L)`
    где:
    \*   `I` — интенсивность излучения, прошедшего через среду.
    \*   `I₀` — исходная интенсивность излучения.
    \*   `σ` — extinction coefficient ([σ] = 1/м).
    \*   `L` — длина пути (м).

Эта величина характеризует, насколько среда ослабляет оптическое излучение за счет поглощения и рассеяния. Это **безразмерная величина, отнесенная к метру**.

\*   **Децибел (дБ) и Непер (Нп):** Это логарифмические **относительные безразмерные единицы**. Они используются для выражения отношения двух одноименных физических величин, в нашем случае — интенсивностей.

Ослабление сигнала в децибелах (dB) определяется как:
`A_dB = 10 * log₁₀(I₀ / I)`

Ослабление сигнала в неперах (Np) определяется через натуральный логарифм:
`A_Np = (1/2) * ln(I₀ / I)` (Для интенсивности множитель 1/2, для амплитуды поля его нет. В задачах распространения излучения обычно работают с интенсивностью.)

Теперь выразим ослабление, используя определение из FDS.
Из Закона Бугера: `I / I₀ = exp(-σ * L)`, следовательно, `I₀ / I = exp(σ * L)`.

\*   **Подставляем в формулу для децибел:**
    `A_dB = 10 * log₁₀( exp(σ * L) ) = 10 * log₁₀(e) * σ * L ≈ 4.3429 * σ * L`

\*   **Подставляем в формулу для непер:**
    `A_Np = (1/2) * ln( exp(σ * L) ) = (1/2) * σ * L = 0.5 * σ * L`

Нас интересует не полное ослабление на пути `L`, а ослабление **на единицу длины**. Для этого разделим обе части уравнений на `L` (м):

\*   **Связь дБ/м и 1/м:**
    `(A_dB / L) = 4.3429 * σ`
    или
    `σ [1/м] = (A_dB / L [дБ/м]) / 4.3429 ≈ (A_dB / L [дБ/м]) * 0.23026`

\*   **Связь Нп/м и 1/м:**
    `(A_Np / L) = 0.5 * σ`
    или
    `σ [1/м] = (A_Np / L [Нп/м]) / 0.5 = 2 * (A_Np / L [Нп/м])`

В Методике указано: **0.2 дБ/м** или **0.023 Нп/м**. Проверим, согласуются ли эти два значения между собой через найденные коэффициенты.

\*   Переведем 0.2 дБ/м в 1/м:
    `σ = 0.2 / 4.3429 ≈ 0.04605 1/м`

\*   Переведем 0.023 Нп/м в 1/м:
    `σ = 2 * 0.023 = 0.046 1/м`

**Вывод:** Значения идеально согласуются (небольшое расхождение ввиду округления). Методика использует корректные преобразования.

1.  FDS в своих уравнениях использует Закон Бугера в экспоненциальной форме, где extinction coefficient `σ` имеет размерность **[1/м]**.
2.  Пожарный извещатель в модели FDS срабатывает, когда смоделированное значение `σ` (в 1/м) превышает значение `SETPOINT`.
3.  Методика МЧС №1140 устанавливает порог срабатывания для дымового извещателя по ослаблению светового потока, равному **0.2 дБ/м**.
4.  Чтобы "объяснить" FDS, какой физический порог мы моделируем, мы должны перевести порог из логарифмических единиц (дБ/м) в линейные (1/м), которые понимает решатель.
5.  Используя выведенное соотношение:
    `σ_setpoint [1/м] = (Порог_в_дБ/м) / (10 * log₁₀(e))`
    `σ_setpoint [1/м] = 0.2 / 4.342944819 ≈ 0.04605 1/м`

Для строгого соответствия требованиям методики МЧС №1140 при задании порога срабатывания дымового извещателя в FDS, в параметре `SETPOINT` необходимо указывать значение, полученное путем пересчета из дБ/м в 1/м.

**Правильная запись в FDS-файле будет выглядеть так:**

```fortran
&DEVC ID='Smoke Detector', QUANTITY='EXTINCTION COEFFICIENT', XYZ=0.5,0.5,2.0, SETPOINT=0.04605 /
```

Где `0.04605 1/м` — это и есть порог **0.2 дБ/м**, выраженный в единицах измерения, которые использует FDS для внутренних расчетов.

Таким образом *EXTINCTION COEFFICIENT* и *OPTICAL DENSITY* в FDS - это одно и то же. Разница лишь в том, что в **PCTT** для ***EXTINCTION COEFFICIENT*** в качестве единицы измерения используется **дБ/м**, а для ***OPTICAL DENSITY*** используется **Нп/м**, а также соответствующие критические значения: **0.04605 дБ/м** и **0.0461 Нп/м** соответстенно с округлением в большую сторону, согласно [**приложению 11 Методики 1140**](https://ivo.garant.ru/#/document/406577165/paragraph/1532/doclist/6480/1/0/0/%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D0%B8%D0%BA%D0%B0%201140:0).

Например, Fenix+ и FireRisk (от Карькина) используют параметр Extinction Coefficient.

По окончании моделирования пожара, программа вычисляет, в какой момент времени площадь области ***F*** достигла такого значения, что её эффективный диаметр (***dэфф***) стал больше нормативного расстояния между извещателями (***L***). Этот момент времени и есть ***tпор***.

![firegoaway_pctt_demo_gif-min](https://github.com/firegoaway/Plot_CSV_Time_Threshhold/blob/main/.gitpics/pctt_demo_gif-min.gif)

### Поддерживаемые версии FDS
> [**FDS 6.9.1**](https://github.com/firemodels/fds/releases/tag/FDS-6.9.1)
> [**FDS 6.9.0**](https://github.com/firemodels/fds/releases/tag/FDS-6.9.0)
> [**FDS 6.8.0**](https://github.com/firemodels/fds/releases/tag/FDS-6.8.0)

## Как установить и пользоваться
> **PCTT** работает как самостоятельно, так и в связке с утилитой [**Zmejka**](https://github.com/firegoaway/Zmejka)

|	№ п/п	|	Действие	|
|---------|---------|
|	1	|	Скачайте последнюю версию **Zmejka** в разделе [**Releases**](https://github.com/firegoaway/Zmejka/releases)	|
|	2	|	Запустите **Zmejka.exe**. Нажмите **"Выбрать .fds"** и выберите файл сценария FDS	|
|	3	|	Во вкладке **"Настройки"** нажмите **"Insert_DEVC"**. Откроется новое окно	|
|	4	|	В окне **Insert_DEVC** выберите параметр, воздействующий на пожарный извещатель и введите высоту помещения. Нажмите **OK**. Важно помнить, что высоту помещенения нужно указать абсолютную. То есть, если помещение имеет высоту 3 м, но находится на 2 этаже, то в поле ***Hпом =*** нужно вписать **6**. Если помещение имеет высоту 3 м, но находится на 10 этаже, то ***Hпом = 30***. Помните также, что программа воспринимает дробные числа только с **точкой (.)** в качестве десятичного разделителя, то есть число **3,5** нужно вводить как **3.5**	|
|	5	|	В окне **Zmejka** вернитесь во вкладку **"Главный экран"**. Вновь нажмите **"Выбрать .fds"** и выберите файл сценария FDS с постфиксом **_tout**. Его программа создаёт рядом с оригинальным файлом сценария	|
|	6	|	Запустите моделирование пожара, нажав **"Старт"**. После завершения моделирования в папке с указанным файлом сценария FDS будет находиться файл формата CSV **scenario_name_tout_devc.csv**	|
|	7	|	Перейдите во вкладку **"Настройки"** и нажмите на кнопку **"PCTT"**. Откроется новое окно. Если **PCTT** запущена через **Zmejka**, то все нужные параметры в полях подставляются автоматически 	|
|	8	|	Нажмите на кнопку **"Browse CSV"**. Выберите файл формата CSV **scenario_name_tout_devc.csv**. Нажмите **"Draw"**	|
|	9	|	Немного подождите, пока утилита анализирует данные, содержащиеся в файле. Время анализа зависит от объёма данных. После окончания утилита сохранит график в формате **.png** рядом с файлом проекта **".fnx"**	|

## Статус разработки
> **Альфа**

## Профилактика вирусов и угроз
- Утилита **"PCTT"** предоставляется **"как есть"**.
- Актуальная версия утилиты доступна в разделе [**Releases**](https://github.com/firegoaway/Plot_CSV_Time_Threshhold/releases), однако использовать утилиту в отрыве от [**Zmejka**](https://github.com/firegoaway/Zmejka) не рекомендуется.
- Файлы, каким-либо образом полученные не из текущего репозитория, несут потенциальную угрозу вашему ПК.
- Файл с расширением **.exe**, полученный из данного репозитория, имеет уникальную Хэш-сумму, позволяющую отличить оригинальную утилиту от подделки.
- Хэш-сумма обновляется только при обновлении версии утилиты и всегда доступна в конце файла **README.md**.

### Актуальная Хэш-сумма
> PCTT.exe - **2f85644d0bfeb7e332b328f13933ee3e**

> Insert_DEVC.exe - **665edaff58ac0fad34f6c1600d2536e3**